#!/usr/bin/env bash
"exec" "$HOME/.dotfiles/.venv/bin/python3" "$0" "$@"

from pathlib import Path
import yaml
import json
import re
from subprocess import check_output
from configparser import ConfigParser
from os import getenv
from git import Repo, exc

DEV_PATH = Path(getenv('DEV_PATH') or Path().home().joinpath('dev/'))
CWD = Path().cwd()
CURRENT_DIR_NAME = CWD.name
REGEX_SCM_TO_NAME = re.compile(r'([^\/]+$)')

VENV_PATH = CWD.joinpath('.venv/')

ROLES_PATH = Path.home().joinpath('dev/ansible-roles/')
ANSIBLE_ROLES_PATH = Path().home().joinpath('.ansible/roles/')

VSCODE_WORKSPACES_PATH = Path.home().joinpath('dev/vscode-workspaces/')
VSCODE_WORKSPACE_FILE_PATH = VSCODE_WORKSPACES_PATH.joinpath(
    f'{CURRENT_DIR_NAME}.code-workspace'
)

ANSIBLE_CFG = CWD.joinpath('ansible.cfg')
if ANSIBLE_CFG.exists():
    print('Found ansible.cfg in current directory')
    config = ConfigParser()
    config.read(str(ANSIBLE_CFG))
    if 'defaults' in config and 'roles_path' in config['defaults']:
        ANSIBLE_ROLES_PATH = CWD.joinpath(config['defaults']['roles_path'])

workspace = {
    'folders': [{'name': CURRENT_DIR_NAME, 'path': str(CWD)}],
    'settings': {
        '[yaml]': {'editor.defaultFormatter': 'tomaciazek.ansible'},
        '[yml]': {'editor.defaultFormatter': 'tomaciazek.ansible'},
        'ansible.python.activationScript': str(VENV_PATH.joinpath('bin/activate')),
    },
}

ansible_requirements = []
for path in CWD.glob('**/requirements.y*ml'):
    with open(path, 'r') as requirement:
        ansible_requirements.append(yaml.safe_load(requirement))

for requirement in ansible_requirements:
    if 'roles' in requirement:
        for role in [
            role
            for role in requirement['roles']
            if 'src' in role and 'scm' in role and role['scm'] == 'git'
        ]:
            match = REGEX_SCM_TO_NAME.search(role['src'].replace('.git', ''))
            if match:
                name = match.group(0)
                path = ROLES_PATH.joinpath(name)
                workspace['folders'].append({'name': name, 'path': str(path)})
                if path.exists() and path.joinpath('.git/').exists():
                    print(f'Repo "{name}" exists locally at {str(path)}')
                    repo = Repo(str(path))
                else:
                    print(f'Cloning Repo "{name}" to {str(path)}')
                    path.mkdir(parents=True, exist_ok=True)
                    repo = Repo.clone_from(role['src'], str(path))

                for remote in repo.remotes:
                    remote.fetch()

                if 'version' in role:
                    try:
                        print(f'Checking out "{name}" to {role["version"]}')
                        repo.git.execute(['git', 'checkout', role["version"]])
                    except exc.GitCommandError as e:
                        print(
                            f'Can\'t checkout repository "{name}" to {role["version"]}'
                        )
                        raise
                else:
                    if 'master' in repo.remotes:
                        repo.git.execute(['git', 'checkout', 'master'])
                    elif 'main' in repo.remotes:
                        repo.git.execute(['git', 'checkout', 'main'])

                symlink_path = ANSIBLE_ROLES_PATH.joinpath(name)
                if not symlink_path.exists():
                    print(f'Created symlink: {str(symlink_path)} -> {str(path)}')
                    symlink_path.symlink_to(path)

VSCODE_WORKSPACES_PATH.mkdir(parents=True, exist_ok=True)
with open(VSCODE_WORKSPACE_FILE_PATH, 'w+') as file:
    json.dump(workspace, file, indent=2)
